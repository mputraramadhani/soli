/**
 * @license
 * Lo-Dash 1.2.1 (Custom Build) <http://lodash.com/>
 * Build: `lodash underscore exports="amd,commonjs,global,node" -o ./dist/lodash.underscore.js`
 * Copyright 2012-2013 The Dojo Foundation <http://dojofoundation.org/>
 * Based on Underscore.js 1.4.4 <http://underscorejs.org/>
 * Copyright 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
 * Available under MIT license <http://lodash.com/license>
 */ /**
 * @license RequireJS text 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */ /**
 * @license RequireJS i18n 2.0.2 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/i18n for details
 */ /** @license
 * RequireJS Image Plugin
 * Author: Miller Medeiros
 * Version: 0.2.2 (2013/02/08)
 * Released under the MIT license
 */ /*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */ (function(t){function n(t){return t instanceof n?t:new a(t)}function e(t){return t.charCodeAt(0)}function i(t,n){var e=t.index,i=n.index;if((t=t.criteria)!==(n=n.criteria)){if(t>n||void 0===t)return 1;if(t<n||void 0===n)return -1}return e<i?-1:1}function r(t,n,e,i){var r=m(t),o=!e,s=n;if(o){var a=i;e=n}else if(!r){if(!i)throw TypeError();n=t}return function i(){var c=arguments,l=o?this:n;if(r||(t=n[s]),e.length&&(c=c.length?(c=tN.call(c),a?c.concat(e):e.concat(c)):e),this instanceof i){u.prototype=t.prototype,l=new u,u.prototype=null;var f=t.apply(l,c);return y(f)?f:l}return t.apply(l,c)}}function o(t){return"\\"+th[t]}function s(t){return tO[t]}function a(t){this.__wrapped__=t}function u(){}function c(t){return tF[t]}function l(t){return tx.call(t)==to}function f(t){if(!t)return t;for(var n=1,e=arguments.length;n<e;n++){var i=arguments[n];if(i)for(var r in i)t[r]=i[r]}return t}function p(t){if(!t)return t;for(var n=1,e=arguments.length;n<e;n++){var i=arguments[n];if(i)for(var r in i)null==t[r]&&(t[r]=i[r])}return t}function h(t){var n=[];return tM(t,function(t,e){m(t)&&n.push(e)}),n.sort()}function d(t){for(var n=-1,e=t3(t),i=e.length,r={};++n<i;){var o=e[n];r[t[o]]=o}return r}function v(t){if(!t)return!0;if(tR(t)||$(t))return!t.length;for(var n in t)if(t_.call(t,n))return!1;return!0}function m(t){return"function"==typeof t}function y(t){return!!t&&tp[typeof t]}function g(t){return"number"==typeof t||tx.call(t)==tc}function $(t){return"string"==typeof t||tx.call(t)==tf}function b(t){for(var n=-1,e=t3(t),i=e.length,r=Array(i);++n<i;)r[n]=t[e[n]];return r}function w(t,n){var e=t?t.length:0,i=!1;return"number"==typeof e?i=z(t,n)>-1:tB(t,function(t){return(i=t===n)&&J}),i}function k(t,n,e){var i=!0;n=q(n,e);var r=-1,o=t?t.length:0;if("number"==typeof o)for(;++r<o&&(i=!!n(t[r],r,t)););else tB(t,function(t,e,r){return!(i=!!n(t,e,r))&&J});return i}function x(t,n,e){var i=[];n=q(n,e);var r=-1,o=t?t.length:0;if("number"==typeof o)for(;++r<o;){var s=t[r];n(s,r,t)&&i.push(s)}else tB(t,function(t,e,r){n(t,e,r)&&i.push(t)});return i}function A(t,n,e){n=q(n,e);var i,r=-1,o=t?t.length:0;if("number"!=typeof o)return tB(t,function(t,e,r){if(n(t,e,r))return i=t,J}),i;for(;++r<o;){var s=t[r];if(n(s,r,t))return s}}function T(t,n,e){var i=-1,r=t?t.length:0;if(n=n&&void 0===e?n:q(n,e),"number"==typeof r)for(;++i<r&&n(t[i],i,t)!==J;);else tB(t,n)}function E(t,n,e){var i=-1,r=t?t.length:0;if(n=q(n,e),"number"==typeof r)for(var o=Array(r);++i<r;)o[i]=n(t[i],i,t);else o=[],tB(t,function(t,e,r){o[++i]=n(t,e,r)});return o}function S(t,n,e){var i=-1/0,r=i,o=-1,s=t?t.length:0;if(n||"number"!=typeof s)n=q(n,e),T(t,function(t,e,o){var s=n(t,e,o);s>i&&(i=s,r=t)});else for(;++o<s;){var a=t[o];a>r&&(r=a)}return r}function j(t,n){var e=-1,i=t?t.length:0;if("number"==typeof i)for(var r=Array(i);++e<i;)r[e]=t[e][n];return r||E(t,n)}function C(t,n,e,i){if(!t)return e;var r=arguments.length<3;n=q(n,i,4);var o=-1,s=t.length;if("number"==typeof s)for(r&&(e=t[++o]);++o<s;)e=n(e,t[o],o,t);else tB(t,function(t,i,o){e=r?(r=!1,t):n(e,t,i,o)});return e}function P(t,n,e,i){var r=t,o=t?t.length:0,s=arguments.length<3;if("number"!=typeof o){var a=t3(t);o=a.length}return n=q(n,i,4),T(t,function(t,i,u){i=a?a[--o]:--o,e=s?(s=!1,r[i]):n(e,r[i],i,u)}),e}function N(t,n,e){n=q(n,e);var i,r=-1,o=t?t.length:0;if("number"==typeof o)for(;++r<o&&!(i=n(t[r],r,t)););else tB(t,function(t,e,r){return(i=n(t,e,r))&&J});return!!i}function L(t,n,e){return e&&v(n)?null:(e?A:x)(t,n)}function U(t){for(var n=-1,e=t.length,i=tb.apply(td,tN.call(arguments,1)),r=[];++n<e;){var o=t[n];0>z(i,o)&&r.push(o)}return r}function R(t,n,e){if(t){var i=0,r=t.length;if("number"!=typeof n&&null!=n){var o=-1;for(n=q(n,e);++o<r&&n(t[o],o,t);)i++}else if(null==(i=n)||e)return t[0];return tN.call(t,0,tP(tC(0,i),r))}}function z(t,n,e){var i=-1,r=t?t.length:0;if("number"==typeof e)i=(e<0?tC(0,r+e):e||0)-1;else if(e)return t[i=F(t,n)]===n?i:-1;for(;++i<r;)if(t[i]===n)return i;return -1}function O(t,n,e){if("number"!=typeof n&&null!=n){var i=0,r=-1,o=t?t.length:0;for(n=q(n,e);++r<o&&n(t[r],r,t);)i++}else i=null==n||e?1:tC(0,n);return tN.call(t,i)}function F(t,n,e,i){var r=0,o=t?t.length:r;for(n=(e=e?q(e,i,1):D)(n);r<o;){var s=r+o>>>1;e(t[s])<n?r=s+1:o=s}return r}function M(t,n,e,i){var r=-1,o=t?t.length:0,s=[],a=s;for("boolean"!=typeof n&&null!=n&&(i=e,e=n,n=!1),null!=e&&(a=[],e=q(e,i));++r<o;){var u=t[r],c=e?e(u,r,t):u;(n?!r||a[a.length-1]!==c:0>z(a,c))&&(e&&a.push(c),s.push(u))}return s}function B(t,n){return tU.fastBind||tA&&arguments.length>2?tA.call.apply(tA,arguments):r(t,n,tN.call(arguments,2))}function q(t,n,e){if(null==t)return D;var i=typeof t;if("function"!=i){if("object"!=i)return function(n){return n[t]};var r=t3(t);return function(n){for(var e=r.length,i=!1;e--&&(i=n[r[e]]===t[r[e]]););return i}}return void 0!==n?1===e?function(e){return t.call(n,e)}:2===e?function(e,i){return t.call(n,e,i)}:4===e?function(e,i,r,o){return t.call(n,e,i,r,o)}:function(e,i,r){return t.call(n,e,i,r)}:t}function D(t){return t}function I(t){T(h(t),function(e){var i=n[e]=t[e];n.prototype[e]=function(){var t=[this.__wrapped__];t8.apply(t,arguments);var e=i.apply(n,t);return this.__chain__&&((e=new a(e)).__chain__=!0),e}})}function H(t,n){return n(t),t}function X(){return String(this.__wrapped__)}var W,G="object"==typeof exports&&exports,Y="object"==typeof module&&module&&module.exports==G&&module,V="object"==typeof global&&global;(V.global===V||V.window===V)&&(t=V);var Z,K=0,J={},tt=+new Date+"",tn=/&(?:amp|lt|gt|quot|#39);/g,te=/($^)/,ti=/[&<>"']/g,tr=/['\n\r\t\u2028\u2029\\]/g,to="[object Arguments]",ts="[object Array]",ta="[object Boolean]",tu="[object Date]",tc="[object Number]",tl="[object RegExp]",tf="[object String]",tp={boolean:!1,function:!0,object:!0,number:!1,string:!1,undefined:!1},th={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},td=[],tv={},tm=t._,ty=RegExp("^"+String(tv.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),tg=Math.ceil,t$=t.clearTimeout,tb=td.concat,tw=Math.floor,t_=tv.hasOwnProperty,t8=td.push,tk=t.setTimeout,tx=tv.toString,tA=ty.test(tA=tx.bind)&&tA,tT=ty.test(tT=Array.isArray)&&tT,tE=t.isFinite,tS=t.isNaN,tj=ty.test(tj=Object.keys)&&tj,tC=Math.max,tP=Math.min,t0=Math.random,tN=td.slice,tL=ty.test(t.attachEvent),t1=tA&&!/\n|true/.test(tA+tL),tU={};Z={0:1,length:1},tU.fastBind=tA&&!t1,tU.spliceObjects=(td.splice.call(Z,0,1),!Z[0]),n.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,variable:""},a.prototype=n.prototype,l(arguments)||(l=function(t){return!!t&&t_.call(t,"callee")});var tR=tT||function(t){return!!t&&"object"==typeof t&&tx.call(t)==ts},tz=function(t){var n,e=t,i=[];if(!e||!tp[typeof t])return i;for(n in e)t_.call(e,n)&&i.push(n);return i},t3=tj?function(t){return y(t)?tj(t):[]}:tz,tO={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},tF=d(tO),tM=function(t,n){var e,i=t,r=i;if(!i||!tp[typeof i])return r;for(e in i)if(n(i[e],e,t)===J)break;return r},tB=function(t,n){var e,i=t,r=i;if(!i||!tp[typeof i])return r;for(e in i)if(t_.call(i,e)&&n(i[e],e,t)===J)break;return r};m(/x/)&&(m=function(t){return"function"==typeof t&&"[object Function]"==tx.call(t)}),n.after=function t(n,e){return n<1?e():function(){if(--n<1)return e.apply(this,arguments)}},n.bind=B,n.bindAll=function t(n){for(var e=arguments.length>1?tb.apply(td,tN.call(arguments,1)):h(n),i=-1,r=e.length;++i<r;){var o=e[i];n[o]=B(n[o],n)}return n},n.compact=function t(n){for(var e=-1,i=n?n.length:0,r=[];++e<i;){var o=n[e];o&&r.push(o)}return r},n.compose=function t(){var n=arguments;return function(){for(var t=arguments,e=n.length;e--;)t=[n[e].apply(this,t)];return t[0]}},n.countBy=function t(n,e,i){var r={};return e=q(e,i),T(n,function(t,n,i){n=String(e(t,n,i)),t_.call(r,n)?r[n]++:r[n]=1}),r},n.debounce=function t(n,e,i){var r,o,s,a;function u(){a=null,i||(o=n.apply(s,r))}return function(){var t=i&&!a;return r=arguments,s=this,t$(a),a=tk(u,e),t&&(o=n.apply(s,r)),o}},n.defaults=p,n.defer=function t(n){var e=tN.call(arguments,1);return tk(function(){n.apply(W,e)},1)},n.delay=function t(n,e){var i=tN.call(arguments,2);return tk(function(){n.apply(W,i)},e)},n.difference=U,n.filter=x,n.flatten=function t(n,e){for(var i=-1,r=n?n.length:0,o=[];++i<r;){var s=n[i];tR(s)?t8.apply(o,e?s:t(s)):o.push(s)}return o},n.forEach=T,n.functions=h,n.groupBy=function t(n,e,i){var r={};return e=q(e,i),T(n,function(t,n,i){n=String(e(t,n,i)),(t_.call(r,n)?r[n]:r[n]=[]).push(t)}),r},n.initial=function t(n,e,i){if(!n)return[];var r=0,o=n.length;if("number"!=typeof e&&null!=e){var s=o;for(e=q(e,i);s--&&e(n[s],s,n);)r++}else r=null==e||i?1:e||r;return tN.call(n,0,tP(tC(0,o-r),o))},n.intersection=function t(n){var e=arguments,i=e.length,r=-1,o=n?n.length:0,s=[];e:for(;++r<o;){var a=n[r];if(0>z(s,a)){for(var u=i;--u;)if(0>z(e[u],a))continue e;s.push(a)}}return s},n.invert=d,n.invoke=function t(n,e){var i=tN.call(arguments,2),r=-1,o="function"==typeof e,s=n?n.length:0,a=Array("number"==typeof s?s:0);return T(n,function(t){a[++r]=(o?e:t[e]).apply(t,i)}),a},n.keys=t3,n.map=E,n.max=S,n.memoize=function t(n,e){var i={};return function(){var t=tt+(e?e.apply(this,arguments):arguments[0]);return t_.call(i,t)?i[t]:i[t]=n.apply(this,arguments)}},n.min=function t(n,e,i){var r=1/0,o=r,s=-1,a=n?n.length:0;if(e||"number"!=typeof a)e=q(e,i),T(n,function(t,n,i){var s=e(t,n,i);s<r&&(r=s,o=t)});else for(;++s<a;){var u=n[s];u<o&&(o=u)}return o},n.omit=function t(n){var e=tb.apply(td,tN.call(arguments,1)),i={};return tM(n,function(t,n){0>z(e,n)&&(i[n]=t)}),i},n.once=function t(n){var e,i;return function(){return e||(e=!0,i=n.apply(this,arguments),n=null),i}},n.pairs=function t(n){for(var e=-1,i=t3(n),r=i.length,o=Array(r);++e<r;){var s=i[e];o[e]=[s,n[s]]}return o},n.partial=function t(n){return r(n,tN.call(arguments,1))},n.pick=function t(n){for(var e=-1,i=tb.apply(td,tN.call(arguments,1)),r=i.length,o={};++e<r;){var s=i[e];s in n&&(o[s]=n[s])}return o},n.pluck=j,n.range=function t(n,e,i){n=+n||0,i=+i||1,null==e&&(e=n,n=0);for(var r=-1,o=tC(0,tg((e-n)/i)),s=Array(o);++r<o;)s[r]=n,n+=i;return s},n.reject=function t(n,e,i){return e=q(e,i),x(n,function(t,n,i){return!e(t,n,i)})},n.rest=O,n.shuffle=function t(n){var e=-1,i=n?n.length:0,r=Array("number"==typeof i?i:0);return T(n,function(t){var n=tw(t0()*(++e+1));r[e]=r[n],r[n]=t}),r},n.sortBy=function t(n,e,r){var o=-1,s=n?n.length:0,a=Array("number"==typeof s?s:0);for(e=q(e,r),T(n,function(t,n,i){a[++o]={criteria:e(t,n,i),index:o,value:t}}),s=a.length,a.sort(i);s--;)a[s]=a[s].value;return a},n.tap=H,n.throttle=function t(n,e){function i(){u=new Date,a=null,o=n.apply(s,r)}var r,o,s,a,u=0;return function(){var t=new Date,c=e-(t-u);return r=arguments,s=this,c<=0?(t$(a),a=null,u=t,o=n.apply(s,r)):a||(a=tk(i,c)),o}},n.times=function t(n,e,i){for(var r=-1,o=Array(n>-1?n:0);++r<n;)o[r]=e.call(i,r);return o},n.toArray=function t(n){return tR(n)?tN.call(n):n&&"number"==typeof n.length?E(n):b(n)},n.union=function t(n){return tR(n)||(arguments[0]=n?tN.call(n):td),M(tb.apply(td,arguments))},n.uniq=M,n.values=b,n.where=L,n.without=function t(n){return U(n,tN.call(arguments,1))},n.wrap=function t(n,e){return function(){var t=[n];return t8.apply(t,arguments),e.apply(this,t)}},n.zip=function t(n){for(var e=-1,i=n?S(j(arguments,"length")):0,r=Array(i);++e<i;)r[e]=j(arguments,e);return r},n.collect=E,n.drop=O,n.each=T,n.extend=f,n.methods=h,n.object=function t(n,e){for(var i=-1,r=n?n.length:0,o={};++i<r;){var s=n[i];e?o[s]=e[i]:o[s[0]]=s[1]}return o},n.select=x,n.tail=O,n.unique=M,n.clone=function t(n){return y(n)?tR(n)?tN.call(n):f({},n):n},n.contains=w,n.escape=function t(n){return null==n?"":String(n).replace(ti,s)},n.every=k,n.find=A,n.findWhere=function t(n,e){return L(n,e,!0)},n.has=function t(n,e){return!!n&&t_.call(n,e)},n.identity=D,n.indexOf=z,n.isArguments=l,n.isArray=tR,n.isBoolean=function t(n){return!0===n||!1===n||tx.call(n)==ta},n.isDate=function t(n){return!!n&&"object"==typeof n&&tx.call(n)==tu},n.isElement=function t(n){return!!n&&1===n.nodeType},n.isEmpty=v,n.isEqual=function t(e,i,r,o){if(e===i)return 0!==e||1/e==1/i;var s=typeof e,a=typeof i;if(e==e&&(!e||"function"!=s&&"object"!=s)&&(!i||"function"!=a&&"object"!=a))return!1;if(null==e||null==i)return e===i;var u=tx.call(e);if(u!=tx.call(i))return!1;switch(u){case ta:case tu:return+e==+i;case tc:return e!=+e?i!=+i:0==e?1/e==1/i:e==+i;case tl:case tf:return e==String(i)}var c=u==ts;if(!c){if(e instanceof n||i instanceof n)return t(e.__wrapped__||e,i.__wrapped__||i,r,o);if("[object Object]"!=u)return!1;var l=e.constructor,f=i.constructor;if(l!=f&&!(m(l)&&l instanceof l&&m(f)&&f instanceof f))return!1}r||(r=[]),o||(o=[]);for(var p=r.length;p--;)if(r[p]==e)return o[p]==i;var h=!0,d=0;if(r.push(e),o.push(i),c){if(h=(d=i.length)==e.length)for(;d--&&(h=t(e[d],i[d],r,o)););return h}return tM(i,function(n,i,s){if(t_.call(s,i))return d++,!(h=t_.call(e,i)&&t(e[i],n,r,o))&&J}),h&&tM(e,function(t,n,e){if(t_.call(e,n))return!(h=--d>-1)&&J}),h},n.isFinite=function t(n){return tE(n)&&!tS(parseFloat(n))},n.isFunction=m,n.isNaN=function t(n){return g(n)&&n!=+n},n.isNull=function t(n){return null===n},n.isNumber=g,n.isObject=y,n.isRegExp=function t(n){return!!n&&tp[typeof n]&&tx.call(n)==tl},n.isString=$,n.isUndefined=function t(n){return void 0===n},n.lastIndexOf=function t(n,e,i){var r=n?n.length:0;for("number"==typeof i&&(r=(i<0?tC(0,r+i):tP(i,r-1))+1);r--;)if(n[r]===e)return r;return -1},n.mixin=I,n.noConflict=function n(){return t._=tm,this},n.random=function t(n,e){return null==n&&null==e&&(e=1),n=+n||0,null==e&&(e=n,n=0),n+tw(t0()*((+e||0)-n+1))},n.reduce=C,n.reduceRight=P,n.result=function t(n,e){var i=n?n[e]:null;return m(i)?n[e]():i},n.size=function t(n){var e=n?n.length:0;return"number"==typeof e?e:t3(n).length},n.some=N,n.sortedIndex=F,n.template=function t(e,i,r){e||(e="");var s=0,a="__p += '",u=(r=p({},r,n.templateSettings)).variable,c=RegExp((r.escape||te).source+"|"+(r.interpolate||te).source+"|"+(r.evaluate||te).source+"|$","g");e.replace(c,function(t,n,i,r,u){return a+=e.slice(s,u).replace(tr,o),n&&(a+="' +\n_.escape("+n+") +\n'"),r&&(a+="';\n"+r+";\n__p += '"),i&&(a+="' +\n((__t = ("+i+")) == null ? '' : __t) +\n'"),s=u+t.length,t}),a+="';\n",u||(a="with ("+(u="obj")+" || {}) {\n"+a+"\n}\n"),a="function("+u+") {\nvar __t, __p = '', __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n"+a+"return __p\n}";try{var l=Function("_","return "+a)(n)}catch(f){throw f.source=a,f}return i?l(i):(l.source=a,l)},n.unescape=function t(n){return null==n?"":String(n).replace(tn,c)},n.uniqueId=function t(n){var e=++K+"";return n?n+e:e},n.all=k,n.any=N,n.detect=A,n.foldl=C,n.foldr=P,n.include=w,n.inject=C,n.first=R,n.last=function t(n,e,i){if(n){var r=0,o=n.length;if("number"!=typeof e&&null!=e){var s=o;for(e=q(e,i);s--&&e(n[s],s,n);)r++}else if(null==(r=e)||i)return n[o-1];return tN.call(n,tC(0,o-r))}},n.take=R,n.head=R,n.chain=function t(n){return(n=new a(n)).__chain__=!0,n},n.VERSION="1.2.1",I(n),n.prototype.chain=function t(){return this.__chain__=!0,this},n.prototype.value=function t(){return this.__wrapped__},T(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=td[t];n.prototype[t]=function(){var t=this.__wrapped__;return e.apply(t,arguments),tU.spliceObjects||0!==t.length||delete t[0],this}}),T(["concat","join","slice"],function(t){var e=td[t];n.prototype[t]=function(){var t=this.__wrapped__,n=e.apply(t,arguments);return this.__chain__&&((n=new a(n)).__chain__=!0),n}}),"function"==typeof define&&"object"==typeof define.amd&&define.amd?(t._=n,define("vendor/lodash.underscore",[],function(){return n})):G&&!G.nodeType?Y?(Y.exports=n)._=n:G._=n:t._=n})(this),define("common/Utils",["underscore"],function(t){function n(t){return document.getElementById(t)}function e(t){return t.replace(/^\s+|\s+$/g,"")}var i,r={click:"touchstart",mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},o=document.addEventListener?function(t,e,o){if(t){var s,a,u,c;t="string"==typeof t?n(t):t,o=(s=o,(c=r[a=e])?function(t){var n=t.type===c;return i&&!n?i=!1:(i=n,s.call(this,t))}:s),r[e]&&t.addEventListener(r[e],o,!0),t.addEventListener(e,o,!0)}}:function(t,e,i){t&&(t="string"==typeof t?n(t):t).attachEvent("on"+e,function(t){var n;return t=((n=(n=t)||event).preventDefault||(n.preventDefault=function(){this.returnValue=!1}),n.stopPropagation||(n.stopPropagation=function(){this.cancelBubble=!0}),n),i.call(t.target||t.srcElement,t)})},s=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,n){window.setTimeout(t,n||1e3/60)};return{$:n,on:o,position:function t(n){var e=0,i=0;if(n.offsetParent)do e+=n.offsetLeft,i+=n.offsetTop;while(n=n.offsetParent);return{x:e,y:i}},addClass:function t(n,i){var r,o;r=n,o=i,-1!==(" "+r.className+" ").indexOf(" "+o+" ")||(n.className=e(n.className+" "+i))},removeClass:function t(n,i){n.className=e((" "+n.className+" ").replace(" "+i+" "," "))},requestAnimationFrame:_.bind(s,window),format:function t(n){if("number"!=typeof n)return"--:--";var e=(n=~~(n/1e3))%60,i=~~(n/60),r=~~(i/60);return(r?(r>9?r:"0"+r)+":":"")+((i%=60)>9?i:"0"+i%60)+":"+(e>9?e:"0"+e)}}}),function(t,n){"object"==typeof module&&module.exports?module.exports=function(t){return n(t=t||require("underscore"))}:"function"==typeof define&&define.amd?define("vendor/postal.min",["underscore"],function(e){return n(e,t)}):t.postal=n(t._,t)}(this,function(t){var n="postal",e=function(){var n;return function(e){var i=!1;return t.isString(e)?(i=e===n,n=e):(i=t.isEqual(e,n),n=t.clone(e)),!i}},i=function(){var n=[];return function(e){var i=!t.any(n,function(n){return t.isObject(e)||t.isArray(e)?t.isEqual(e,n):e===n});return i&&n.push(e),i}},r=function(t){this.channel=t||"/"};r.prototype.subscribe=function(){return 1===arguments.length?new o(this.channel,arguments[0].topic,arguments[0].callback):new o(this.channel,arguments[0],arguments[1])},r.prototype.publish=function(){var t=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};return t.channel=this.channel,u.configuration.bus.publish(t)};var o=function(t,e,i){this.channel=t,this.topic=e,this.callback=i,this.constraints=[],this.context=null,u.configuration.bus.publish({channel:n,topic:"subscription.created",data:{event:"subscription.created",channel:t,topic:e}}),u.configuration.bus.subscribe(this)};o.prototype={unsubscribe:function(){u.configuration.bus.unsubscribe(this),u.configuration.bus.publish({channel:n,topic:"subscription.removed",data:{event:"subscription.removed",channel:this.channel,topic:this.topic}})},defer:function(){var t=this.callback;return this.callback=function(n){setTimeout(t,0,n)},this},disposeAfter:function(n){if(t.isNaN(n)||0>=n)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var e=this.callback,i=t.after(n,t.bind(function(){this.unsubscribe()},this));return this.callback=function(){e.apply(this.context,arguments),i()},this},distinctUntilChanged:function(){return this.withConstraint(new e),this},distinct:function(){return this.withConstraint(new i),this},once:function(){this.disposeAfter(1)},withConstraint:function(n){if(!t.isFunction(n))throw"Predicate constraint must be a function";return this.constraints.push(n),this},withConstraints:function(n){var e=this;return t.isArray(n)&&t.each(n,function(t){e.withConstraint(t)}),e},withContext:function(t){return this.context=t,this},withDebounce:function(n){if(t.isNaN(n))throw"Milliseconds must be a number";var e=this.callback;return this.callback=t.debounce(e,n),this},withDelay:function(n){if(t.isNaN(n))throw"Milliseconds must be a number";var e=this.callback;return this.callback=function(t){setTimeout(function(){e(t)},n)},this},withThrottle:function(n){if(t.isNaN(n))throw"Milliseconds must be a number";var e=this.callback;return this.callback=t.throttle(e,n),this},subscribe:function(t){return this.callback=t,this}};var s=function(n,e){u.configuration.resolver.compare(n.topic,e.topic)&&t.all(n.constraints,function(t){return t.call(n.context,e.data,e)})&&"function"==typeof n.callback&&n.callback.call(n.context,e.data,e)},a={addWireTap:function(t){var n=this;return n.wireTaps.push(t),function(){var e=n.wireTaps.indexOf(t);-1!==e&&n.wireTaps.splice(e,1)}},publish:function(n){return n.timeStamp=new Date,t.each(this.wireTaps,function(t){t(n.data,n)}),this.subscriptions[n.channel]&&t.each(this.subscriptions[n.channel],function(t){for(var e,i=0,r=t.length;r>i;)(e=t[i++])&&s(e,n)}),n},reset:function(){this.subscriptions&&(t.each(this.subscriptions,function(n){t.each(n,function(t){for(;t.length;)t.pop().unsubscribe()})}),this.subscriptions={})},subscribe:function(t){var n,e=this.subscriptions[t.channel];return e||(e=this.subscriptions[t.channel]={}),(n=this.subscriptions[t.channel][t.topic])||(n=this.subscriptions[t.channel][t.topic]=[]),n.push(t),t},subscriptions:{},wireTaps:[],unsubscribe:function(t){if(this.subscriptions[t.channel][t.topic]){for(var n=this.subscriptions[t.channel][t.topic].length,e=0;n>e;e++)if(this.subscriptions[t.channel][t.topic][e]===t){this.subscriptions[t.channel][t.topic].splice(e,1);break}}}};a.subscriptions[n]={};var u={configuration:{bus:a,resolver:{cache:{},regex:{},compare:function(n,e){var i,r,o,s=this.cache[e]&&this.cache[e][n];return void 0!==s||((r=this.regex[n])||(i="^"+t.map(n.split("."),function(t){var n=o&&"#"!==o?"\\.\\b":"\\b";return n+="#"===t?"[A-Z,a-z,0-9,\\.]*":"*"===t?"[A-Z,a-z,0-9]+":t,o=t,n}).join("")+"$",r=this.regex[n]=RegExp(i)),this.cache[e]=this.cache[e]||{},this.cache[e][n]=s=r.test(e)),s},reset:function(){this.cache={},this.regex={}}},DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:n},ChannelDefinition:r,SubscriptionDefinition:o,channel:function(t){return new r(t)},subscribe:function(t){return new o(t.channel||"/",t.topic,t.callback)},publish:function(t){return t.channel=t.channel||"/",u.configuration.bus.publish(t)},addWireTap:function(t){return this.configuration.bus.addWireTap(t)},linkChannels:function(n,e){var i=[];return n=t.isArray(n)?n:[n],e=t.isArray(e)?e:[e],t.each(n,function(n){n.topic,t.each(e,function(e){var r=e.channel||"/";i.push(u.subscribe({channel:n.channel||"/",topic:n.topic||"#",callback:function(n,i){var o=t.clone(i);o.topic=t.isFunction(e.topic)?e.topic(i.topic):e.topic||i.topic,o.channel=r,o.data=n,u.publish(o)}}))})}),i},utils:{getSubscribersFor:function(){var t=arguments[0],n=arguments[1];return 1===arguments.length&&(t=arguments[0].channel||u.configuration.DEFAULT_CHANNEL,n=arguments[0].topic),u.configuration.bus.subscriptions[t]&&u.configuration.bus.subscriptions[t].hasOwnProperty(n)?u.configuration.bus.subscriptions[t][n]:[]},reset:function(){u.configuration.bus.reset(),u.configuration.resolver.reset()}}};return u}),define("common/EventBus",["postal","underscore"],function(t,n){var e=t.channel();return e.on=n.bind(e.subscribe,e),e.emit=n.bind(e.publish,e),e}),define("common/Storage",["./EventBus"],function(t){function n(t){try{return JSON.parse(localStorage.getItem(r+t))}catch(n){return null}}function e(t,n){i&&localStorage.setItem(r+t,JSON.stringify(n))}var i,r="::html5-solitaire::";try{localStorage.getItem("test"),i=!0}catch(o){i=!1}return{save:e,get:n,increment:function t(i){var r=parseInt(n(i),10)||0;e(i,r+1)}}}),define("UI/Sound",[],function(){function t(t,i,r){if(n){this.__path=t,this.currentAudio=0,this.TOTAL=i||1,this.enabled=!0,this.audio=[],this._loaded=[];var o,s,a=this;for(this.onload=function(t){clearTimeout(s),a._loaded.push(this),this.oncanplaythrough=null,this.removeEventListener("canplaythrough",a._loaded),a._loaded.length>.3*i&&r&&(r(),r=null)},e&&(s=setTimeout(function(){r(),r=null})),o=0;o<i;o++)this.audio[o]=new Audio;e||this.load(t)}}var n=!1,e=/iphone|ipod|ipad/i.test(navigator.userAgent);try{n=!!(new Audio).canPlayType}catch(i){}return t.prototype.load=function(t){if(t=t||this.__path,n){var e,i=(this.audio[0].canPlayType("audio/ogg"),".ogg");for(e=0;e<this.TOTAL;e++)this.audio[e].addEventListener("canplaythrough",this.onload,!0),this.audio[e].src=require.toUrl("assets/"+t+i)}},t.prototype.setEnabled=function(){this.enabled=!this.enabled},t.prototype.play=function(){n&&this.enabled&&this._loaded.length&&(this._loaded[this.currentAudio-1]&&(this._loaded[this.currentAudio-1].currentTime=0),this._loaded[this.currentAudio].play(),this.currentAudio=(this.currentAudio+1)%this._loaded.length)},t.prototype.stop=function(){this._loaded[this.currentAudio].pause(),this._loaded[this.currentAudio].currentTime=0},t}),define("UI/Score",["common/Utils"],function(t){var n=0;return{initialize:function(n){return n=n||{},this.opts=n,this.every="number"==typeof n.every?1e3*n.every:null,this.points=0,this.e_clock=t.$(n.timer),this.e_point=t.$(n.score),this.e_point&&(this.layout=this.e_point.innerHTML||"%d points"),this.updatePoints(),this},now:function(){return(new Date).getTime()},reset:function(){this.stop(),this.start=this.stopTime=this.last=this.now(),this.points=_.isNumber(this.opts.startPoint)?this.opts.startPoint:0,this.updatePoints(),this.updateTime(),this._start=!1},restart:function(){this._start||(this.reset(),this.startTimer(),this._start=!0)},updatePoints:function(){this.e_point&&(this.e_point.innerHTML=this.layout.replace("%d",this.points))},updateTime:function(){this.e_clock&&(this.e_clock.innerHTML=this.time())},startTimer:function(){var t=this;this.uuid=n,function e(){if(t.uuid===n){var i=t.stopTime=t.now();t.updateTime(),i-t.last>(t.every||1e4)&&(t.last=i,t.down(-(t.opts.deduct||2))),setTimeout(e,1e3)}}()},stop:function(){++n},up:function(t){_.isNumber(t)&&t>0&&(this.points+=t,this.updatePoints())},down:function(t){_.isNumber(t)&&t<0&&(this.points+=t,this.updatePoints())},getTime:function(){return this.stopTime-this.start},getScore:function(){return this.points},time:function(){return t.format(this.stopTime-this.start)}}}),define("vendor/require-plugins/text",["module"],function(t){var n,e,i=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],r=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,o=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,s="undefined"!=typeof location&&location.href,a=s&&location.protocol&&location.protocol.replace(/\:/,""),u=s&&location.hostname,c=s&&(location.port||void 0),l=[],f=t.config&&t.config()||{};return n={version:"2.0.1",strip:function(t){if(t){var n=(t=t.replace(r,"")).match(o);n&&(t=n[1])}else t="";return t},jsEscape:function(t){return t.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:f.createXhr||function(){var t,n,e;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(n=0;n<3;n+=1){e=i[n];try{t=new ActiveXObject(e)}catch(r){}if(t){i=[e];break}}return t},parseName:function(t){var n=!1,e=t.indexOf("."),i=t.substring(0,e),r=t.substring(e+1,t.length);return -1!==(e=r.indexOf("!"))&&(n="strip"===(n=r.substring(e+1,r.length)),r=r.substring(0,e)),{moduleName:i,ext:r,strip:n}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(t,e,i,r){var o,s,a,u=n.xdRegExp.exec(t);return!u||(o=u[2],a=(s=(s=u[3]).split(":"))[1],s=s[0],(!o||o===e)&&(!s||s.toLowerCase()===i.toLowerCase())&&(!a&&!s||a===r))},finishLoad:function(t,e,i,r){i=e?n.strip(i):i,f.isBuild&&(l[t]=i),r(i)},load:function(t,e,i,r){if(r.isBuild&&!r.inlineText){i();return}f.isBuild=r.isBuild;var o=n.parseName(t),l=o.moduleName+"."+o.ext,p=e.toUrl(l),h=f.useXhr||n.useXhr;!s||h(p,a,u,c)?n.get(p,function(e){n.finishLoad(t,o.strip,e,i)},function(t){i.error&&i.error(t)}):e([l],function(t){n.finishLoad(o.moduleName+"."+o.ext,o.strip,t,i)})},write:function(t,e,i,r){if(l.hasOwnProperty(e)){var o=n.jsEscape(l[e]);i.asModule(t+"!"+e,"define(function () { return '"+o+"';});\n")}},writeFile:function(t,e,i,r,o){var s=n.parseName(e),a=s.moduleName+"."+s.ext,u=i.toUrl(s.moduleName+"."+s.ext)+".js";n.load(a,i,function(e){var i=function(t){return r(u,t)};i.asModule=function(t,n){return r.asModule(t,u,n)},n.write(t,a,i,o)},o)}},"undefined"!=typeof process&&process.versions&&process.versions.node?(e=require.nodeRequire("fs"),n.get=function(t,n){var i=e.readFileSync(t,"utf8");0===i.indexOf("\uFEFF")&&(i=i.substring(1)),n(i)}):n.createXhr()?n.get=function(t,e,i){var r=n.createXhr();r.open("GET",t,!0),f.onXhr&&f.onXhr(r,t),r.onreadystatechange=function(n){var o,s;4===r.readyState&&((o=r.status)>399&&o<600?((s=Error(t+" HTTP status: "+o)).xhr=r,i(s)):e(r.responseText))},r.send(null)}:"undefined"!=typeof Packages&&(n.get=function(t,n){var e,i,r=new java.io.File(t),o=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(r),"utf-8")),a="";try{for(e=new java.lang.StringBuffer,(i=s.readLine())&&i.length()&&65279===i.charAt(0)&&(i=i.substring(1)),e.append(i);null!==(i=s.readLine());)e.append(o),e.append(i);a=String(e.toString())}finally{s.close()}n(a)}),n}),define("vendor/require-plugins/text!UI/template.html",[],function(){return'<ul id="html5-solitaire-sidebar">\n    <li><button data-sol-action="restart"><i class="icon-refresh"></i> <%= _e("newGame") %></button></li>\n    <li><button data-sol-action="switch-sound"><i id="solitaire-sound-icon" class="icon-volume-up"></i> <%= _e("sound") %></button></li>\n    <li><button data-sol-action="draw3"><i id="solitaire-draw3-icon" class="icon-check-empty"></i> <%= _e("draw3") %></button></li>\n    <li><button data-sol-action="show-stats"><i class="icon-bar-chart"></i> <%= _e("stats") %></button></li>\n  </ul>\n  <div id="html5-solitaire-board">\n  <ul id="html5-solitaire-topbar">\n    <li id="html5-solitaire-options"><button><i class="icon-reorder"></i></button>\n    <span id="html5-solitaire-timer">00:00</span>\n    </li>\n    <li id="html5-solitaire-undo"><button><i class="icon-undo"></i> <span><%= _e("undo") %></span></button></li>\n    <li id="html5-solitaire-score"><%= _e("pointsTemplate") %></li>\n  </ul>\n  <canvas id="html5-solitaire-canvas"></canvas>\n  <div id="html5-solitaire-board-overlay"></div>\n</div>\n<div id="html5-solitaire-overlay"></div>\n\n  <div id="html5-solitaire-dialog">\n    <div id="html5-solitaire-dialog-message"></div>\n  </div>'}),function(){function t(t,n,e,i,r,o){n[t]&&(e.push(t),(!0===n[t]||1===n[t])&&i.push(r+t+"/"+o))}function n(t,n,e,i,r){var o=i+n+"/"+r;require._fileExists(t.toUrl(o+".js"))&&e.push(o)}function e(t,n,i){var r;for(r in n)n.hasOwnProperty(r)&&(!t.hasOwnProperty(r)||i)?t[r]=n[r]:"object"==typeof n[r]&&e(t[r],n[r],i)}var i=/(^.*(^|\/)nls(\/|$))([^\/]*)\/?([^\/]*)/;define("vendor/require-plugins/i18n",["module"],function(r){var o=r.config?r.config():{};return{version:"2.0.1+",load:function(r,s,a,u){(u=u||{}).locale&&(o.locale=u.locale);var c,l,f,p=i.exec(r),h=p[1],d=p[4],v=p[5],m=d.split("-"),y=[],g={},$="";if(p[5]?c=(h=p[1])+v:(c=r,v=p[4],(d=o.locale)||(d=o.locale="undefined"==typeof navigator?"root":(navigator.language||navigator.userLanguage||"root").toLowerCase()),m=d.split("-")),u.isBuild){for(y.push(c),n(s,"root",y,h,v),l=0;l<m.length;l++)f=m[l],$+=($?"-":"")+f,n(s,$,y,h,v);s(y,function(){a()})}else s([c],function(n){var i,r=[];for(t("root",n,r,y,h,v),l=0;l<m.length;l++)i=m[l],$+=($?"-":"")+i,t($,n,r,y,h,v);s(y,function(){var t,i,o;for(t=r.length-1;t>-1&&r[t];t--)(!0===(i=n[o=r[t]])||1===i)&&(i=s(h+o+"/"+v)),e(g,i);a(g)})})}}})}(),define("vendor/require-plugins/image",[],function(){function t(){}var n="!bust",e="!rel";return{load:function(n,i,r,o){var s;o.isBuild?r(null):((s=new Image).onerror=function(t){r.error(t)},s.onload=function(n){r(s);try{delete s.onload}catch(e){s.onload=t}},-1!==n.indexOf(e)?s.src=i.toUrl(n.replace(e,"")):s.src=n)},normalize:function(t,e){var i;return -1===t.indexOf(n)?t:(i=(i=t).replace(n,""),(i+=0>i.indexOf("?")?"?":"&")+"bust="+Math.round(2147483647*Math.random()))}}}),define("view/pile",["image!assets/images/sprite.webp!rel"],function(t){function n(n,e,s,a,c,l){var f=o;e&&(e.faceup&&(f=(u[e.suit]+e.rank)*i),n.drawImage(t,f,0,i,r,s,a,c||i,l||r))}var e,i=t.width/53,r=t.height,o=52*i,s=.07*r|0,a=.3*r|0,u=((e=document.createElement("canvas")).getContext&&e.getContext("2d"),{"♥":0,"♣":13,"♦":26,"♠":39});return{cardWidth:i,cardHeight:r,initialize:function(t){var n;for(n in t)t.hasOwnProperty(n)&&(this[n]=t[n]);return this.originalX=this.x,this.originalY=this.y,this},hitTest:function(t){var n=0;return"tableau"==this.type&&(n=this.countCardsUpsidedown()*s),t.x>=this.x&&t.x<=this.x+this.getWidth()&&t.y>=this.y+n&&t.y<=this.y+this.getHeight()},getWidth:function(){return i},getShadowBlur:function(){return 4},getHeight:function(){return"tableau"!==this.type?r:this.getOffsetTop()+r},getOffsetTop:function(){var t=this.countCardsUpsidedown(),n=(this.size()-t-1)*a;return t*s+n},getNextCardPosition:function(){return{x:this.x,y:"tableau"!==this.type?this.y:this.y+this.getOffsetTop()+a}},getCards:function(t){if(!this.hitTest(t)||!this.size())return -1;if("tableau"!==this.type)return 1;var n=this.countCardsUpsidedown(),e=this.size()-n,i=~~((t.y-this.y-n*s)/a);return i>e-1&&(i=e-1),e-i},getSelection:function(t){var n,e=Object.create(this);return e.cards=this.cards.splice(-t),n=this.getNextCardPosition(),e.lastX=e.x=n.x,e.lastY=e.y=n.y,e.original=this,e},draw:function(t,e){if(!this.size())return this.drawPlaceholder(t);var i,r,o=this.cards,u=(this.type,this.draw3&&!this.original?70:0),c=this.y;for(this.lastX=this.x,this.lastY=this.y,t.shadowColor="#555","tableau"!==this.type||e?"waste"!==this.type||e||(t.shadowOffsetX=-1,t.shadowOffsetY=-1):t.shadowOffsetY=-1,i=0,r=this.size();i<r;i++)n(t,o[i],this.x-(i>=r-3&&this.draw3?u*((2-(i-(r-3)))%3):0),c),"tableau"==this.type&&(c+=o[i].faceup?a:s)},drawPlaceholder:function(t){t.fillStyle="rgba(0, 0, 0, .3)",t.shadowColor="rgba(0,0,0,0)",t.fillRect(this.originalX,this.originalY,i,r)},clear:function(t){t.fillRect(this.lastX,this.lastY,this.getWidth(),this.getHeight())},turn:function(t,e,o){if(this.size()){var a=this.y+("tableau"!==this.type?0:(this.size()-1)*s),u=this.x,c=i*(1-2*e),l={},f="stock"===this.type?this.cards[this.cards.length-2]:{};e>.5&&(c=Math.min(c=i*(e-.5)*2,i),(l=this.cards[this.size()-1]).faceup=!0),c=~~c||1,t.fillRect(u,a,i,r+10),f?this.size()>1&&n(t,f,u,a-("tableau"!==this.type?0:s)):this.drawPlaceholder(t),"left"===o?u-=e>.5?c:0:"right"===o?u+=e>.5?i:i-c:u+=(i-c)/2,n(t,l,~~u,~~a,~~c)}},restorePosition:function(){this.x=this.originalX,this.y=this.originalY},countCardsUpsidedown:function(){return _.filter(this.cards,function(t){return!t.faceup}).length},pop:function(){return this.cards.pop()},push:function(){return this.cards.push.apply(this.cards,arguments)},last:function(){return this.cards[this.cards.length-1]},empty:function(){this.cards.length=0},size:function(){return this.cards.length},valueOf:function t(){return this.rank+1+this.suit}}});var EventEmitter=function(){};EventEmitter.prototype.setMaxListeners=function(t){this._events||(this._events={}),this._events.maxListeners=t},Array.isArray=Array.isArray||function(t){return t.sort&&t.length&&t.slice},EventEmitter.prototype.emit=function(t){if("error"===t&&(!this._events||!this._events.error||Array.isArray(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var n=this._events[t];if(!n)return!1;if("function"==typeof n){switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:var e=Array.prototype.slice.call(arguments,1);n.apply(this,e)}return!0}if(Array.isArray(n)){for(var e=Array.prototype.slice.call(arguments,1),i=n.slice(),r=0,o=i.length;r<o;r++)i[r].apply(this,e);return!0}return!1},EventEmitter.prototype.publish=EventEmitter.prototype.emit,EventEmitter.prototype.addListener=function(t,n){if("function"!=typeof n)throw Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",t,n),this._events[t]){if(Array.isArray(this._events[t])){if(this._events[t].push(n),!this._events[t].warned){var e;(e=void 0!==this._events.maxListeners?this._events.maxListeners:10)&&e>0&&this._events[t].length>e&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),console.trace())}}else this._events[t]=[this._events[t],n]}else this._events[t]=n;return this},EventEmitter.prototype.on=EventEmitter.prototype.subscribe=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(t,n){function e(){i.removeListener(t,e),n.apply(this,arguments)}if("function"!=typeof n)throw Error(".once only takes instances of Function");var i=this;return e.listener=n,i.on(t,e),this},EventEmitter.prototype.removeListener=function(t,n){if("function"!=typeof n)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[t])return this;var e=this._events[t];if(Array.isArray(e)){for(var i=-1,r=0,o=e.length;r<o;r++)if(e[r]===n||e[r].listener&&e[r].listener===n){i=r;break}if(i<0)return this;e.splice(i,1),0==e.length&&delete this._events[t]}else(e===n||e.listener&&e.listener===n)&&delete this._events[t];return this},EventEmitter.prototype.unsubscribe=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(t){return 0===arguments.length?(this._events={},this):(t&&this._events&&this._events[t]&&(this._events[t]=null),this)},EventEmitter.prototype.listeners=function(t){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),Array.isArray(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]},EventEmitter.mixin=function(t){for(var n in EventEmitter.prototype)t.prototype[n]||(t.prototype[n]=EventEmitter.prototype[n])},define("vendor/EventEmitter.min",function(){}),define("common/Selector",["./Utils","EventEmitter"],function(t){function n(n){this.element=n,this._loop=_.bind(a,this),t.on(n,"mousedown",_.bind(r,this)),t.on(n,"mousemove",_.bind(_.throttle(s,1e3/(l?10:50)),this)),t.on(n,"mouseup",_.bind(o,this)),t.on(n,"mouseout",_.bind(o,this)),t.on(n,"dblclick",_.bind(i,this))}function e(t){return t.touches&&t.touches.length?t.touches[0]:t}function i(t){c(t),t=e(t),this.emit("tap",this.points_)}function r(n){c(n),n=e(n),this.isMousedown=!0,this.pos=t.position(this.element);var i=this.getPosition(n);return this.points_={start:i,last:i,current:i},this.emit("down",this.points_),this.start=i,!1}function o(t){var n="touchend"===t.type;if(p++,c(t),this.isMousedown=!1,!this.mousemove||u(this.points_.start,this.points_.current)<f)return n&&this.emit("tap",this.points_);this.mousemove=!1,t=e(t),this.emit("stop",this.points_)}function s(t){if(c(t),!this.isMousedown){this.__ticked===p&&p++;return}t=e(t),this.points_.last=this.points_.current,this.points_.current=this.getPosition(t),(this.mousemove||u(this.points_.start,this.points_.current)>f)&&(this.mousemove||this.emit("start",this.points_),this.mousemove=!0,this.__ticked!==p&&(this.__ticked=p,this._loop()))}function a(){this.__ticked===p&&(h(this._loop,1e3/(l?20:60)),this.emit("move",this.points_),this.points_.last=this.points_.current)}function u(t,n){var e=t.x-n.x,i=t.y-n.y;return e*e+i*i}function c(t){t.stopPropagation(),t.preventDefault()}var l=/mobil|android|ios/ig.test(navigator.userAgent),f=10;EventEmitter.mixin(n),n.prototype.getPosition=function(t){var n={};return n.x=t.pageX-this.pos.x||t.offsetX||0,n.y=t.pageY-this.pos.y||t.offsetY||0,n};var p=0,h=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,n){window.setTimeout(t,n||1e3/60)};return n}),define("view/board",["underscore","./pile","common/Utils","common/Selector","common/EventBus"],function(t,n,e,i,r){function o(t,e,i){return Object.create(n).initialize({cards:e,type:t,pos:i,x:(n.cardWidth+10)*i,y:(n.cardHeight+10)*("tableau"===t?1:0)})}var s,a=[],u=/iphone|ipod|ipad/i.test(navigator.userAgent),c=(n.cardHeight+10)*5,l=(n.cardWidth+10)*7,f=document.createElement("canvas"),p=(s=f).getContext?s.getContext("2d"):null,h=t.once(function(){var n=this,o=new i(this.canvas),s={},a=!1,u=!1;r.on("animation.start",function(){a=n.inAnimation=!0}),r.on("animation.end",function(){a=n.inAnimation=!1}),r.on("__move.start",function(){u=!0}),r.on("__move.end",function(){u=!1}),o.on("tap",function(t){a||!s.pile||u||r.emit("pile.tap",s)}),o.on("down",t.bind(function(t){if(r.emit("pointer.down",s),!a&&(s.start=this.transformPoint(t.start),s.pile=this.getPileUnderPoint(s.start),s.pile)){f.width=f.width;var n="stock"===s.pile.type?"stock.clicked":"pile.selected";r.emit(n,s)}},this)),o.on("start",t.bind(function(){!a&&s.pile&&r.emit("pile.drag.start",s)},this)),o.on("move",t.bind(function(t){!a&&s.pile&&(s.current=this.transformPoint(t.current),s.last=this.transformPoint(t.last),r.emit("pile.drag.move",s))},this)),o.on("stop",t.bind(function(t){s.pile=this.getPileUnderPoint(this.transformPoint(t.current)),r.emit("pile.drag.end",s)},this)),e.on(window,"resize",t.bind(this.resize,this))});return{initialize:function(n,e){this.canvas=n,this.ctx=n.getContext("2d");var i=t.bind(o,null,"tableau"),r=t.bind(o,null,"foundation"),s=t.map([[],[],[],[],[],[],[]],i),u=t.map(e.foundations,r),c=o("waste",e.waste,5),l=o("stock",e.stock,6);return l.push.apply(l,[].concat.apply([],e.tableaus).reverse()),a=this.piles=[].concat(s,u,c,l),this.resize(),h.call(this),this},resize:function(){var t=this.canvas.parentNode.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,t.width>t.height?this.scale=t.height/c:this.scale=t.width/(l+n.cardWidth),u&&(this.scale*=1.1),this.marginLeft=parseInt((t.width-l*this.scale)/2),this.marginTop=50,this.drawAll()},drawAll:function(t){var n,e=this.ctx,i=this.piles.length;for(e.fillStyle="#003300",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.translate(this.marginLeft,this.marginTop),e.scale(this.scale,this.scale),n=0;n<i;n+=1)this.piles[n].draw(e);e.restore()},constrain:function(t,n,e){return(t=Math.max(t,0))+n>e?e-n:t},initializeDirtyRectangle:function(t){this.draw(t,!0)},clearDirty:function(){f.width=f.width,f.height=f.height},draw:function(t,n){var e=this.canvas.width,i=this.canvas.height,r=(t.lastX*this.scale+this.marginLeft|0)-2,o=(t.lastY*this.scale+this.marginTop|0)-2,s=(t.x*this.scale+this.marginLeft|0)-2,a=(t.y*this.scale+this.marginTop|0)-2,u=Math.ceil(t.getWidth()*this.scale)+4,c=Math.ceil(t.getHeight()*this.scale)+4,l=this.ctx;s=this.constrain(s,u,e),a=this.constrain(a,c,i),r=this.constrain(r,u,e),o=this.constrain(o,c,i),l.fillStyle="#003300",t.lastX=t.x,t.lastY=t.y,n?this.drawAll(!0):l.fillRect(r,o,u,c),l.drawImage(f,r,o),f.width=u,f.height=c,p.drawImage(this.canvas,s,a,u,c,0,0,u,c),l.save(),l.translate(this.marginLeft,this.marginTop),l.scale(this.scale,this.scale),t.draw(l,!0),l.restore()},transformPoint:function(t){return{x:(t.x-this.marginLeft)/this.scale|0,y:(t.y-this.marginTop)/this.scale|0}},getPileUnderPoint:function(n){return t.find(a,function(t){return t.hitTest(n)})}}}),function(t){if("function"==typeof bootstrap)bootstrap("promise",t);else if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define("vendor/q",t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=t}else Q=t()}(function(){function t(t){return function(){return N.apply(t,arguments)}}function n(t){return t===Object(t)}function e(t,n){if(A&&n.stack&&"object"==typeof t&&null!==t&&t.stack&&-1===t.stack.indexOf(D)){for(var e=[],r=n;r;r=r.source)r.stack&&e.unshift(r.stack);e.unshift(t.stack);var s=e.join("\n"+D+"\n");t.stack=function t(n){for(var e=n.split("\n"),r=[],s=0;s<e.length;++s){var a=e[s];o(a)||i(a)||!a||r.push(a)}return r.join("\n")}(s)}}function i(t){return -1!==t.indexOf("(module.js:")||-1!==t.indexOf("(node.js:")}function r(t){var n=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(t);if(n)return[n[1],Number(n[2])];var e=/at ([^ ]+):(\d+):(?:\d+)$/.exec(t);if(e)return[e[1],Number(e[2])];var i=/.*@(.+):(\d+)$/.exec(t);if(i)return[i[1],Number(i[2])]}function o(t){var n=r(t);if(!n)return!1;var e=n[0],i=n[1];return e===E&&i>=j&&i<=Y}function s(){if(A)try{throw Error()}catch(t){var n=t.stack.split("\n"),e=r(n[0].indexOf("@")>0?n[1]:n[2]);if(!e)return;return E=e[0],e[1]}}function a(t){var n,e;return h(t)?t:d(t)?(n=t,e=u(),P(function(){try{n.then(e.resolve,e.reject,e.notify)}catch(t){e.reject(t)}}),e.promise):g(t)}function u(){function t(t){n=t,o.source=t,U(e,function(n,e){P(function(){t.promiseDispatch.apply(t,e)})},void 0),e=void 0,i=void 0}var n,e=[],i=[],r=O(u.prototype),o=O(l.prototype);if(o.promiseDispatch=function(t,r,o){var s=L(arguments);e?(e.push(s),"when"===r&&o[1]&&i.push(o[1])):P(function(){n.promiseDispatch.apply(n,s)})},o.valueOf=function(){if(e)return o;var t=p(n);return h(t)&&(n=t),t},o.inspect=function(){return n?n.inspect():{state:"pending"}},a.longStackSupport&&A)try{throw Error()}catch(s){o.stack=s.stack.substring(s.stack.indexOf("\n")+1)}return r.promise=o,r.resolve=function(e){n||t(a(e))},r.fulfill=function(e){n||t(g(e))},r.reject=function(e){n||t(y(e))},r.notify=function(t){n||U(i,function(n,e){P(function(){e(t)})},void 0)},r}function c(t){if("function"!=typeof t)throw TypeError("resolver must be a function.");var n=u();try{t(n.resolve,n.reject,n.notify)}catch(e){n.reject(e)}return n.promise}function l(t,n,e){void 0===n&&(n=function(t){return y(Error("Promise does not support operation: "+t))}),void 0===e&&(e=function(){return{state:"unknown"}});var i=O(l.prototype);if(i.promiseDispatch=function(e,r,o){var s;try{s=t[r]?t[r].apply(i,o):n.call(i,r,o)}catch(a){s=y(a)}e&&e(s)},i.inspect=e,e){var r=e();"rejected"===r.state&&(i.exception=r.reason),i.valueOf=function(){var t=e();return"pending"===t.state||"rejected"===t.state?i:t.value}}return i}function f(t,n,e,i){return a(t).then(n,e,i)}function p(t){if(h(t)){var n=t.inspect();if("fulfilled"===n.state)return n.value}return t}function h(t){return n(t)&&"function"==typeof t.promiseDispatch&&"function"==typeof t.inspect}function d(t){return n(t)&&"function"==typeof t.then}function v(){for(var t=0;t<H.length;t++){var n=H[t];console.warn("Unhandled rejection reason:",n)}}function m(){H.length=0,X.length=0,W=!1,G||(G=!0,"undefined"!=typeof process&&process.on&&process.on("exit",v))}function y(t){var n,e,i=l({when:function(n){return n&&function t(n){if(G){var e=R(X,n);-1!==e&&(X.splice(e,1),H.splice(e,1))}}(this),n?n(t):this}},function(){return this},function(){return{state:"rejected",reason:t}});return n=i,e=t,G&&(X.push(n),e&&void 0!==e.stack?H.push(e.stack):H.push("(no stack) "+e),!W&&"undefined"!=typeof window&&window.console&&console.warn("[Q] Unhandled rejection reasons (should be empty):",H),W=!0),i}function g(t){return l({when:function(){return t},get:function(n){return t[n]},set:function(n,e){t[n]=e},delete:function(n){delete t[n]},post:function(n,e){return null==n?t.apply(void 0,e):t[n].apply(t,e)},apply:function(n,e){return t.apply(n,e)},keys:function(){return M(t)}},void 0,function(){return{state:"fulfilled",value:t}})}function $(t,n,e){return a(t).spread(n,e)}function b(t,n,e){return a(t).dispatch(n,e)}function w(t){return f(t,function(t){var n=0,e=u();return U(t,function(i,r,o){var s;h(r)&&"fulfilled"===(s=r.inspect()).state?t[o]=s.value:(++n,f(r,function(i){t[o]=i,0==--n&&e.resolve(t)},e.reject,function(t){e.notify({index:o,value:t})}))},void 0),0===n&&e.resolve(t),e.promise})}function k(t){return f(t,function(t){return t=z(t,a),f(w(z(t,function(t){return f(t,C,C)})),function(){return t})})}var x,A=!1;try{throw Error()}catch(T){A=!!T.stack}var E,S,j=s(),C=function(){},P=function(){function t(){for(;n.next;){var e=(n=n.next).task;n.task=void 0;var r=n.domain;r&&(n.domain=void 0,r.enter());try{e()}catch(s){if(o)throw r&&r.exit(),setTimeout(t,0),r&&r.enter(),s;setTimeout(function(){throw s},0)}r&&r.exit()}i=!1}var n={task:void 0,next:null},e=n,i=!1,r=void 0,o=!1;if(P=function(t){e=e.next={task:t,domain:o&&process.domain,next:null},i||(i=!0,r())},"undefined"!=typeof process&&process.nextTick)o=!0,r=function(){process.nextTick(t)};else if("function"==typeof setImmediate)r="undefined"!=typeof window?setImmediate.bind(window,t):function(){setImmediate(t)};else if("undefined"!=typeof MessageChannel){var s=new MessageChannel;s.port1.onmessage=function(){r=a,s.port1.onmessage=t,t()};var a=function(){s.port2.postMessage(0)};r=function(){setTimeout(t,0),a()}}else r=function(){setTimeout(t,0)};return P}(),N=Function.call,L=t(Array.prototype.slice),U=t(Array.prototype.reduce||function(t,n){var e=0,i=this.length;if(1===arguments.length)for(;;){if(e in this){n=this[e++];break}if(++e>=i)throw TypeError()}for(;e<i;e++)e in this&&(n=t(n,this[e],e));return n}),R=t(Array.prototype.indexOf||function(t){for(var n=0;n<this.length;n++)if(this[n]===t)return n;return -1}),z=t(Array.prototype.map||function(t,n){var e=this,i=[];return U(e,function(r,o,s){i.push(t.call(n,o,s,e))},void 0),i}),O=Object.create||function(t){function n(){}return n.prototype=t,new n},F=t(Object.prototype.hasOwnProperty),M=Object.keys||function(t){var n=[];for(var e in t)F(t,e)&&n.push(e);return n},B=t(Object.prototype.toString);S="undefined"!=typeof ReturnValue?ReturnValue:function(t){this.value=t};try{Function("(function* (){ yield 1; })"),x=!0}catch(q){x=!1}var D="From previous event:";a.resolve=a,a.nextTick=P,a.longStackSupport=!1,a.defer=u,u.prototype.makeNodeResolver=function(){var t=this;return function(n,e){n?t.reject(n):arguments.length>2?t.resolve(L(arguments,1)):t.resolve(e)}},a.promise=c,a.passByCopy=function(t){return t},l.prototype.passByCopy=function(){return this},a.join=function(t,n){return a(t).join(n)},l.prototype.join=function(t){return a([this,t]).spread(function(t,n){if(t===n)return t;throw Error("Can't join: not the same: "+t+" "+n)})},a.race=function t(n){return c(function(t,e){for(var i=0,r=n.length;i<r;i++)a(n[i]).then(t,e)})},l.prototype.race=function(){return this.then(a.race)},a.makePromise=l,l.prototype.toString=function(){return"[object Promise]"},l.prototype.then=function(t,n,i){var r=this,o=u(),s=!1;return P(function(){r.promiseDispatch(function(n){s||(s=!0,o.resolve(function n(e){try{return"function"==typeof t?t(e):e}catch(i){return y(i)}}(n)))},"when",[function(t){s||(s=!0,o.resolve(function t(i){if("function"==typeof n){e(i,r);try{return n(i)}catch(o){return y(o)}}return y(i)}(t)))}])}),r.promiseDispatch(void 0,"when",[void 0,function(t){var n,e,r=!1;try{e=(n=t,"function"==typeof i?i(n):n)}catch(s){if(r=!0,!a.onerror)throw s;a.onerror(s)}r||o.notify(e)}]),o.promise},a.when=f,l.prototype.thenResolve=function(t){return this.then(function(){return t})},a.thenResolve=function(t,n){return a(t).thenResolve(n)},l.prototype.thenReject=function(t){return this.then(function(){throw t})},a.thenReject=function(t,n){return a(t).thenReject(n)},a.nearer=p,a.isPromise=h,a.isPromiseAlike=d,a.isPending=function t(n){return h(n)&&"pending"===n.inspect().state},l.prototype.isPending=function(){return"pending"===this.inspect().state},a.isFulfilled=function t(n){return!h(n)||"fulfilled"===n.inspect().state},l.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},a.isRejected=function t(n){return h(n)&&"rejected"===n.inspect().state},l.prototype.isRejected=function(){return"rejected"===this.inspect().state};var I,H=[],X=[],W=!1,G=!0;a.resetUnhandledRejections=m,a.getUnhandledReasons=function(){return H.slice()},a.stopUnhandledRejectionTracking=function(){m(),"undefined"!=typeof process&&process.on&&process.removeListener("exit",v),G=!1},m(),a.reject=y,a.fulfill=g,a.master=function t(n){return l({isDef:function(){}},function(t,e){return b(n,t,e)},function(){return a(n).inspect()})},a.spread=$,l.prototype.spread=function(t,n){return this.all().then(function(n){return t.apply(void 0,n)},n)},a.async=function t(n){return function(){function t(t,n){var o,s;if(x){try{o=e[t](n)}catch(a){return y(a)}return o.done?o.value:f(o.value,i,r)}try{o=e[t](n)}catch(u){return"[object StopIteration]"===B(s=u)||s instanceof S?u.value:y(u)}return f(o,i,r)}var e=n.apply(this,arguments),i=t.bind(t,"next"),r=t.bind(t,"throw");return i()}},a.spawn=function t(n){a.done(a.async(n)())},a.return=function t(n){throw new S(n)},a.promised=function t(n){return function(){return $([this,w(arguments)],function(t,e){return n.apply(t,e)})}},a.dispatch=b,l.prototype.dispatch=function(t,n){var e=this,i=u();return P(function(){e.promiseDispatch(i.resolve,t,n)}),i.promise},a.get=function(t,n){return a(t).dispatch("get",[n])},l.prototype.get=function(t){return this.dispatch("get",[t])},a.set=function(t,n,e){return a(t).dispatch("set",[n,e])},l.prototype.set=function(t,n){return this.dispatch("set",[t,n])},a.del=a.delete=function(t,n){return a(t).dispatch("delete",[n])},l.prototype.del=l.prototype.delete=function(t){return this.dispatch("delete",[t])},a.mapply=a.post=function(t,n,e){return a(t).dispatch("post",[n,e])},l.prototype.mapply=l.prototype.post=function(t,n){return this.dispatch("post",[t,n])},a.send=a.mcall=a.invoke=function(t,n){return a(t).dispatch("post",[n,L(arguments,2)])},l.prototype.send=l.prototype.mcall=l.prototype.invoke=function(t){return this.dispatch("post",[t,L(arguments,1)])},a.fapply=function(t,n){return a(t).dispatch("apply",[void 0,n])},l.prototype.fapply=function(t){return this.dispatch("apply",[void 0,t])},a.try=a.fcall=function(t){return a(t).dispatch("apply",[void 0,L(arguments,1)])},l.prototype.fcall=function(){return this.dispatch("apply",[void 0,L(arguments)])},a.fbind=function(t){var n=a(t),e=L(arguments,1);return function(){return n.dispatch("apply",[this,e.concat(L(arguments))])}},l.prototype.fbind=function(){var t=this,n=L(arguments);return function(){return t.dispatch("apply",[this,n.concat(L(arguments))])}},a.keys=function(t){return a(t).dispatch("keys",[])},l.prototype.keys=function(){return this.dispatch("keys",[])},a.all=w,l.prototype.all=function(){return w(this)},a.allResolved=(I=k,function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("allResolved is deprecated, use allSettled instead.",Error("").stack),I.apply(I,arguments)}),l.prototype.allResolved=function(){return k(this)},a.allSettled=function t(n){return a(n).allSettled()},l.prototype.allSettled=function(){return this.then(function(t){return w(z(t,function(t){function n(){return t.inspect()}return(t=a(t)).then(n,n)}))})},a.fail=a.catch=function(t,n){return a(t).then(void 0,n)},l.prototype.fail=l.prototype.catch=function(t){return this.then(void 0,t)},a.progress=function t(n,e){return a(n).then(void 0,void 0,e)},l.prototype.progress=function(t){return this.then(void 0,void 0,t)},a.fin=a.finally=function(t,n){return a(t).finally(n)},l.prototype.fin=l.prototype.finally=function(t){return t=a(t),this.then(function(n){return t.fcall().then(function(){return n})},function(n){return t.fcall().then(function(){throw n})})},a.done=function(t,n,e,i){return a(t).done(n,e,i)},l.prototype.done=function(t,n,i){var r=function(t){P(function(){if(e(t,o),!a.onerror)throw t;a.onerror(t)})},o=t||n||i?this.then(t,n,i):this;"object"==typeof process&&process&&process.domain&&(r=process.domain.bind(r)),o.then(void 0,r)},a.timeout=function(t,n,e){return a(t).timeout(n,e)},l.prototype.timeout=function(t,n){var e=u(),i=setTimeout(function(){e.reject(Error(n||"Timed out after "+t+" ms"))},t);return this.then(function(t){clearTimeout(i),e.resolve(t)},function(t){clearTimeout(i),e.reject(t)},e.notify),e.promise},a.delay=function(t,n){return void 0===n&&(n=t,t=void 0),a(t).delay(n)},l.prototype.delay=function(t){return this.then(function(n){var e=u();return setTimeout(function(){e.resolve(n)},t),e.promise})},a.nfapply=function(t,n){return a(t).nfapply(n)},l.prototype.nfapply=function(t){var n=u(),e=L(t);return e.push(n.makeNodeResolver()),this.fapply(e).fail(n.reject),n.promise},a.nfcall=function(t){var n=L(arguments,1);return a(t).nfapply(n)},l.prototype.nfcall=function(){var t=L(arguments),n=u();return t.push(n.makeNodeResolver()),this.fapply(t).fail(n.reject),n.promise},a.nfbind=a.denodeify=function(t){var n=L(arguments,1);return function(){var e=n.concat(L(arguments)),i=u();return e.push(i.makeNodeResolver()),a(t).fapply(e).fail(i.reject),i.promise}},l.prototype.nfbind=l.prototype.denodeify=function(){var t=L(arguments);return t.unshift(this),a.denodeify.apply(void 0,t)},a.nbind=function(t,n){var e=L(arguments,2);return function(){var i=e.concat(L(arguments)),r=u();return i.push(r.makeNodeResolver()),a(function e(){return t.apply(n,arguments)}).fapply(i).fail(r.reject),r.promise}},l.prototype.nbind=function(){var t=L(arguments,0);return t.unshift(this),a.nbind.apply(void 0,t)},a.nmapply=a.npost=function(t,n,e){return a(t).npost(n,e)},l.prototype.nmapply=l.prototype.npost=function(t,n){var e=L(n||[]),i=u();return e.push(i.makeNodeResolver()),this.dispatch("post",[t,e]).fail(i.reject),i.promise},a.nsend=a.nmcall=a.ninvoke=function(t,n){var e=L(arguments,2),i=u();return e.push(i.makeNodeResolver()),a(t).dispatch("post",[n,e]).fail(i.reject),i.promise},l.prototype.nsend=l.prototype.nmcall=l.prototype.ninvoke=function(t){var n=L(arguments,1),e=u();return n.push(e.makeNodeResolver()),this.dispatch("post",[t,n]).fail(e.reject),e.promise},a.nodeify=function t(n,e){return a(n).nodeify(e)},l.prototype.nodeify=function(t){if(!t)return this;this.then(function(n){P(function(){t(null,n)})},function(n){P(function(){t(n)})})};var Y=s();return a}),define("view/animations",["Q","underscore","common/EventBus","./board","common/Utils"],function(t,n,e,i,r){function o(n,e){var i,r,o=t.defer(),s=e||150,a=(new Date).getTime();return c(function t(){1!==(r=Math.min(Math.max(0,(i=Date.now()-a)/s),1))&&c(t,1e3/60),n(r),1===r&&o.resolve()}),o.promise}function s(){}function a(r){function a(t,n){var r=t.getSelection(1);return i.clearDirty(),i.initializeDirtyRectangle(r),o(u(r,l.getNextCardPosition()),p).then(function(){e.emit("pile.deal.start"),h(l,r),l.push.apply(l,r.cards),i.draw(r)}).then(function(){e.emit("pile.deal.end")})}var c=r.from,l=r.to,f=r.total,p=100,h=r.forEachCard||s;return n.reduce(n.range(f),function(t,e){return t.then(n.bind(a,null,c,e))},t())}function u(t,n){var e=t.x-n.x,r=t.y-n.y,o=t.x,s=t.y;return function(a){t.x!==n.x&&(t.x=o-e*a),t.y!==n.y&&(t.y=s-r*a),i.draw(t)}}var c=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,n){window.setTimeout(t,n||1e3/60)};e.on("game.finish",function e(){function r(t,n){n.cards[0].faceup=!1}var o=n.select(i.piles,{type:"foundation"}),s=n.select(i.piles,{type:"stock"}).pop();return n.reduce(o,function(t,e){return t.then(n.bind(a,null,{from:e,to:s,total:13,time:60,forEachCard:r}))},t())});var l={move:function(t,n,i){return e.emit("animation.start"),o(u(t,n),i).then(function(t){e.emit("animation.end")})},turn:function(t,n,r){var s,a;return e.emit("animation.start"),e.emit("card.flip"),o((s=t,a=n,function(t){i.ctx.save(),i.ctx.translate(i.marginLeft,i.marginTop),i.ctx.scale(i.scale,i.scale),s.turn(i.ctx,t,a),i.ctx.restore()}),r).then(function(t){e.emit("animation.end")})},deal:function r(){var o=n.select(i.piles,{type:"stock"}).pop(),s=n.select(i.piles,{type:"tableau"}),u=0;return e.emit("animation.start"),n.reduce(s,function(t,e){return t.then(n.bind(a,null,{from:o,to:e,time:60,total:++u}))},t()).then(function(){i.drawAll(),e.emit("animation.end")})},turnAndMoveCards:function t(n){var e=n.from,r=n.to,o=r.getNextCardPosition();return i.clearDirty(),i.initializeDirtyRectangle(e),l.move(e,o).then(function(){if(n.turn)return l.turn(e.original,null,0)}).then(function(){r.push.apply(r,e.cards),i.drawAll()})}};return l}),define("Solitaire/utils",["underscore"],function(){var t="♥♣♦♠".split(""),n={"♥":"red","♣":"black","♦":"red","♠":"black"};return{createBoard:function n(){var e=function n(){var e,i,r,o=[];for(e=0;i=t[e];e++)for(r=0;r<13;r++)o.push({suit:i,rank:r});return o}(),i={};return function t(n){var e,i,r=n.length;if(r)for(;--r;)e=n[i=~~(Math.random()*(r+1))],n[i]=n[r],n[r]=e;return n}(e),i.foundations=[[],[],[],[]],i.tableaus=function t(n){var e,i,r=[];for(i=0;i<7;i++)(e=n.splice(0,i+1))[e.length-1].faceup=!0,r.push(e);return r}(e),i.stock=e,i.waste=[],i},getColor:function(t){return n[t.suit]},last:function(t,n){return t[t.length-(n||1)]},clone:function t(n){var e,i,r;if(Array.isArray(n))for(i=0,e=[],r=n.length;i<r;i++)"object"==typeof n[i]?e[i]=t(n[i]):e[i]=n[i];else for(i in e={},n)n.hasOwnProperty(i)&&("object"==typeof n[i]?e[i]=t(n[i]):e[i]=n[i]);return e},every:_.every,all:_.all,delay:_.delay,isArray:function(t){return"[object Array]"===({}).toString.call(t)}}}),define("view/undoredo",["common/EventBus","view/board","underscore","UI/Score","Solitaire/utils","common/Utils"],function(t,n,e,i,r,o){function s(t){this.undoStack=[],this.redoStack=[],this.maxUndo=t||20}function a(t){this.lastCard=t.from.original.last(),this.to=t.from.original,this.from=t.to,this.actions=t,this.cardsToMove=t.from.size(),this.lastCard&&"waste"!==this.to.type&&(this.isLastCardDown=!this.lastCard.faceup)}function u(t){this.stock=t.getPile("stock"),this.waste=t.getPile("waste")}s.prototype={reset:function(){this.undoStack.length=0,this.redoStack.length=0},exec:function(t){this.undoStack.length>=this.maxUndo&&this.undoStack.shift(),this.undoStack.push(t),this.redoStack.splice(0,this.redoStack.length)},undo:function(){if(this.undoStack.length&&!n.inAnimation){var t=this.undoStack.pop();return t.undo(),this.redoStack.unshift(t)}},redo:function(){}},a.prototype={undo:function(){this.isLastCardDown&&(this.lastCard.faceup=!1,t.emit("__undo.score"));var n=this.from.getSelection(this.cardsToMove);t.emit("__undo.score"),t.emit("__undo.move",{to:this.to,from:n,turnLastCard:this.isLastCardDown})}},u.prototype={undo:function(){var i=e.select(n.piles,{type:"stock"}).pop(),o=e.select(n.piles,{type:"waste"}).pop();!this.stock.length&&this.waste.length&&t.emit("__restore.draw"),i.cards=r.clone(this.stock),o.cards=r.clone(this.waste),t.emit("__undo.stock",{stock:this.stock,waste:this.waste}),n.drawAll()}},o.on(document,"keydown",function(t){90===t.keyCode&&t.ctrlKey&&c.undo()});var c=new s(1/0);return t.on("restart",function(){c.reset()}),t.on("__do.undo",function(){c.undo()}),t.on("__game.finish",function(){c.reset()}),{manager:c,command:a,stockAction:u}}),define("Solitaire/main",["Q","./utils","common/EventBus","view/undoredo"],function(t,n,e,i){function r(t){var e=a[t.type]||a[t.type+"s"];return n.isArray(e[t.pos])?e[t.pos]:e}function o(t){return 13===t.length}function s(t){return!!t&&!!t.faceup}t.stopUnhandledRejectionTracking();var a=null;return e.on("__undo.move",function(t){var e=r(t.from),i=r(t.to),o=n.last(i);t.turnLastCard&&(o.faceup=!1),i.push.apply(i,e.splice(-t.from.size()))}),e.on("__undo.stock",function(t){a.stock=t.stock,a.waste=t.waste}),{initialize:function(){return a=n.createBoard(),n.clone(a)},canGet:function(t){var e,i,o;return!!arguments.length&&("tableau"===(o=t.from).type||!(t.cards>1))&&(e=r(t.from),(i=n.last(e,t.cards))&&i.faceup)},canMove:function(t){var e=t,i=this.canGet(e),o=e.to&&"foundation"===e.to.type,s=e.to&&"tableau"===e.to.type;if(!i||!(s||o)||o&&e.cards>1)return!1;var a=n.last(r(e.from),e.cards),u=n.last(r(e.to));return o?this.testFoundation(a,u):this.testTableau(a,u)},testTableau:function(t,e){return!e&&12==t.rank||s(e)&&n.getColor(t)!==n.getColor(e)&&t.rank-e.rank==-1},testFoundation:function(t,n){return!n&&0===t.rank||s(n)&&t.suit===n.suit&&t.rank-n.rank==1},move:function u(c){var u=c;if(!arguments.length||!this.canMove(u))return t.reject(u);e.emit(u.from.type+".to."+u.to.type);var l={from:u.from,to:u.to},f=r(u.from),p=r(u.to),h=n.last(f,u.cards+1);return p.push.apply(p,f.splice(-u.cards)),h&&!s(h)&&(e.emit("card.turn"),h.faceup=!0,l.turn=!0),n.every(a.foundations,o)&&n.delay(e.emit,400,"__game.finish"),i.manager.exec(new i.command(l)),new t(l)},canGetCardFromStock:function(){return!!a.stock.length},getCardFromStock:function(){if(this.canGetCardFromStock()){e.emit("draw.card");var t=a.stock.pop();return t.faceup=!0,a.waste.push(t),n.clone(t)}},fillStock:function(){if(!this.canGetCardFromStock()){e.emit("draw.card");var t,n,i=a.waste,r=a.stock;for(t=0,n=i.length;t<n;t++)i[t].faceup=!1;r.push.apply(r,i.splice(0).reverse())}},areAllUpside:function(){return n.all(a.tableaus,function(t){return n.every(t,function(t){return t.faceup})})},getPile:function(t){return n.clone(a[t])}}}),define("Solitaire",["Solitaire/main"],function(t){return t}),define("view/main",["./board","./animations","Solitaire","underscore","common/EventBus","./undoredo","Q"],function(t,n,e,i,r,o,s){function a(){if(e.areAllUpside()&&!g.inAnimation){var t=i.select(g.piles,{type:"tableau"}).concat([b]),n=0;i.reduce(t,function(t,i){return t.then(function(){return(function t(n){for(var i,r=u(n),o=0;e.canGet({from:n,cards:++o});)if(i=c(o,n,r))return i;return s.reject()})(i).then(function(){n++}).fail(function(){return s()})})},s()).fin(function(){n?a():p().then(a)})}}function u(t){var n=i.select(g.piles,{type:"tableau"}),e=i.select(g.piles,{type:"foundation"});return i.without(e.concat(n),t)}function c(t,i,r){var o,s,a,u,c=i.getSelection(t);for(o=0,length=r.length;o<length;o++)if(a=i.last(),s=r[o].last(),u=a&&s&&a.rank===s.rank,(a||s||"tableau"!==r[o].type||"tableau"!==i.type)&&(!u||!a.faceup||i.type!==r[o].type)&&e.canMove({from:c,to:r[o],cards:t}))return e.move({from:c,to:r[o],cards:c.size()}).then(n.turnAndMoveCards);i.push.apply(i,c.cards)}function l(t){n.turnAndMoveCards(t)}function f(){x||(x=!0,r.emit("game.first.move"))}function p(){return e.canGetCardFromStock()?(o.manager.exec(new o.stockAction(e)),function t(r){if(r)return i.reduce(i.range(r),function(t){return t.then(function(){return n.turn($,"left",150).then(function(){$.size()&&($.pop(),b.push(e.getCardFromStock()),g.drawAll())})})},s())}(b.draw3?3:1)):A>1&&b.size()?(--A,o.manager.exec(new o.stockAction(e)),b.last().faceup=!1,g.drawAll(),g.initializeDirtyRectangle(b),n.move(b,$).then(h)):void s.reject()}function h(){b.restorePosition(),b.empty(),e.fillStock(),$.push.apply($,e.getPile("stock")),g.drawAll()}function d(){w=null}function v(t){var n=t.pile;e.canGet({from:{type:n.type,pos:n.pos},cards:n.getCards(t.start)})&&(r.emit("__move.start"),w=n.getSelection(n.getCards(t.start)),g.initializeDirtyRectangle(w))}function m(t){w&&(w.x+=t.current.x-t.last.x,w.y+=t.current.y-t.last.y,g.draw(w))}function y(){if(w){var t,o,s,u,c,l,f=w,p=(o={x:(t=f).x+t.cardWidth,y:t.y},s={x:t.x,y:t.y+t.cardHeight},u={x:t.x+t.cardWidth,y:t.y+t.cardHeight},c=[g.getPileUnderPoint(t),g.getPileUnderPoint(o),g.getPileUnderPoint(s),g.getPileUnderPoint(u)],l=t.size(),i.find(c,function(n){return e.canMove({from:t,to:n,cards:l})}));e.move({from:f,to:p,cards:f.size()}).then(n.turnAndMoveCards).then(function(){e.areAllUpside()&&a()}).fail(function(t){var e=t.from,i=t.from.original;return n.move(e,i.getNextCardPosition()).then(function(){i.push.apply(i,e.cards),g.drawAll()})}).fin(function(){r.emit("__move.end")})}}var g,$,b,w,k,x=!1,A=0;return r.on("__restore.draw",function(){A++}),{initialize:function(o,s){!t.inAnimation&&(r.emit("game.start"),g=t.initialize(o,e.initialize()),$=i.select(g.piles,{type:"stock"}).pop(),b=i.select(g.piles,{type:"waste"}).pop(),x=!1,i.delay(n.deal,300),b.draw3=s.draw3,A=s.allowedDraws||3,k||(r.emit("game.initialized"),r.on("pointer.down",d),r.on("stock.clicked",p),r.on("stock.clicked",f),r.on("pile.drag.start",f),r.on("pile.drag.start",v),r.on("pile.drag.move",m),r.on("pile.drag.end",y),r.on("__undo.move",l),r.on("pile.tap",function(t){if("foundation"!==t.pile.type){var n,i=t.pile.getCards(t.start);e.canGet({from:t.pile,cards:i})&&(n=c(i,t.pile,u(t.pile))),n&&n.then(a)}}),k=!0,r.on("restart",i.bind(this.initialize,this,o,s)),r.on("draw3",i.bind(function(){s.draw3=b.draw3=!s.draw3},this))))}}}),define("view",["view/main"],function(t){return t}),define("UI/main",["common/Utils","common/EventBus","common/Storage","./Sound","./Score","text!./template.html","underscore","i18n!nls/solitaire","view"],function(t,n,e,i,r,o,s,a,u){function c(t){var e="BUTTON"===t.target.nodeName?t.target:t.target.parentNode,i=e.getAttribute("data-sol-action"),r=e.children[0],o=r.className;i&&(n.emit(i),r.className=f[o]||o)}function l(t){return -1!==t.indexOf("%")?t:t.replace("px","")+"px"}var f={"icon-volume-up":"icon-volume-off","icon-volume-off":"icon-volume-up","icon-check-empty":"icon-check-sign","icon-check-sign":"icon-check-empty"},p=["<h2>Ups! This game only works in modern browsers</h2>","<p>Please update your browser quickly</p>","<ul>",'    <li><a href="http://www.google.com/chrome" title="Google Chrome">Google Chrome</a></li>','    <li><a href="http://www.mozilla.org/" title="Mozilla Firefox">Firefox</a></li>','    <li><a href="http://www.opera.com/download" title="Opera">Opera</a></li>',"</ul>"],h=/iphone|ipod|ipad/i.test(navigator.userAgent);return document.createElement("solitaire"),{initialize:function(f){v="string"==typeof f.container?document.getElementById(f.container):document.getElementsByTagName("solitaire")[0];try{document.createElement("canvas").getContext("2d")}catch(d){var v,m=document.createElement("div");throw m.innerHTML=p.join(""),v.parentNode.replaceChild(m,v),d}if(f=f||{},!v)throw Error("No Element was provided");v.hasAttribute("draw3")&&(f.draw3=!0);var y=parseInt(v.getAttribute("allowedDraws"),10);y>0&&(f.allowedDraws=y);var g,$,b,w=v.getAttribute("width")||"100%",k=v.getAttribute("height")||"100%";this.solitaire=v,v.style.width=l(w),v.style.height=l(k),v.innerHTML=s.template(o)({_e:function(t){return a[t]||t}}),function r(o,a){var u=/android (\d\.\d)/i.exec(navigator.userAgent),c=u?parseFloat(u[1]):0;if(!u||!(c<=2.3)){var l=new i("sound/click",10,a);l.play=s.bind(l.play,l),l.setEnabled=s.bind(l.setEnabled,l),n.on("pile.deal.start",l.play),n.on("card.flip",l.play),n.on("switch-sound",l.setEnabled),n.on("switch-sound",function(){e.save("sound",l.enabled)}),l.enabled=!h,h&&n.on("switch-sound",function(){l.load()}).once(),null===e.get("sound")||h||(l.enabled=e.get("sound")),l.enabled||(t.$("solitaire-sound-icon").className="icon-volume-off")}}(f,function t(){u.initialize(document.getElementById("html5-solitaire-canvas"),f)}),$=(g=f).draw3,null!==e.get("draw3")&&($=g.draw3=e.get("draw3")),n.on("draw3",function(){$=!$,e.save("draw3",$)}),$&&(t.$("solitaire-draw3-icon").className="icon-check-sign"),function t(e){function i(t,n){u.push(n),a[t](n)}var o=e.score||{},a=r.initialize({timer:"html5-solitaire-timer",score:"html5-solitaire-score",every:e.every,deduct:e.deduct});s.bindAll(a),n.on("game.start",a.reset),n.on("game.first.move",a.restart),n.on("__game.finish",function(){a.stop(),n.emit("game.finish",{time:a.getTime(),score:a.getScore(),pretyTime:a.time()})});var u=[];n.on("__undo.score",function(){var t=-u.pop();t>0?a.up(t):a.down(t)}),n.on("foundation.to.foundation",s.bind(i,null,"up",0)),n.on("waste.to.foundation",function(){i("up",o.move_to_foundation||10)}),n.on("tableau.to.foundation",function(){i("up",o.move_to_foundation||10)}),n.on("waste.to.tableau",function(){i("up",o.waste_to_tableau||5)}),n.on("foundation.to.tableau",function(){i("down",-Math.abs(o.foundation_to_tableau)||-15)}),n.on("card.turn",function(){i("up",o.turn_card||5)})}(f),b=!1,t.on("html5-solitaire-sidebar","click",c),t.on("html5-solitaire-options","click",function(){t.addClass(document.body,"html5-solitaire-show-sidebar"),b=!0}),t.on("html5-solitaire-board-overlay","click",function(){t.removeClass(document.body,"html5-solitaire-show-sidebar"),b=!1}),t.on("html5-solitaire-undo","click",function(){n.emit("__do.undo")})}}}),define("UI",["UI/main"],function(t){return t}),define("vendor/require-plugins/text!UI/modal-template.html",[],function(){return'<h1><%= _e("stats") %></h1>\n\n    <button id="html5-solitaire-reset-stats" data-reset-stats><%= _e("resetStats") %></button>\n    <table>\n    <% _.each(\'total wins winPercentage bestTime worstTime bestScore worstScore\'.split(" "), function(key) { %>\n      <tr>\n        <th><%= _e(key) %></th>\n        <td><%= _e(stats[key]) %></td>\n      </tr>\n    <% }); %>\n    </table>\n    <button id="html5-solitaire-dialog-close" data-close-button><%= _e("modalCloseButton") %></button>'}),define("UI/Modal",["common/Utils","common/EventBus","underscore","i18n!nls/solitaire","text!./modal-template.html"],function(t,n,e,i,r){function o(n){t.removeClass(document.body,"html5-solitaire-show-modal")}var s,a,u,c,l={},f=e.once(function(){s=t.$("html5-solitaire-dialog"),a=t.$("html5-solitaire-dialog-message"),u=t.$("html5-solitaire-dialog-close"),c=t.$("html5-solitaire-overlay"),t.on(s,"click",function(t){return t.preventDefault(),t.target.hasAttribute("data-close-button")?o():t.target.hasAttribute("data-reset-stats")&&n.emit("reset-stats"),!1})});return{open:function n(o,u){f(),s.style;var c=t.$("html5-solitaire-template-"+o),p=l[o]||e.template(r)||e.template(c.innerHTML);u._e=function(t){return i[t]||t},l[o]=p,a.innerHTML=p(u),t.addClass(document.body,"html5-solitaire-show-modal")},close:o}}),define("stats/main",["common/Storage","common/EventBus","view/board","UI/Modal","common/Utils","underscore"],function(t,n,e,i,r,o){function s(){var t=o.clone(c);t.winPercentage=(Math.round(c.wins/c.total*100)||0)+"%",t.bestTime=r.format(c.bestTime),t.worstTime=r.format(c.worstTime),i.open("stats",{stats:t})}function a(n){t.increment(n),c[n]=c[n]+1}var u={total:0,wins:0,bestTime:"N/A",worstTime:"N/A",bestScore:"N/A",worstScore:"N/A"},c={},l=o.bind(a,null,"total"),f=o.bind(a,null,"wins");n.on("game.initialized",function n(){o.each(u,function(n,e){var i=t.get(e);c[e]=null!==i?i:u[e]})}),n.on("game.finish",f),n.on("game.finish",function n(e){var i=t.get("bestTime")||1/0,r=t.get("worstTime")||-1/0,o=t.get("bestScore")||-1/0,s=t.get("worstScore")||1/0;e.time<i&&(t.save("bestTime",e.time),c.bestTime=e.time),e.time>r&&(t.save("worstTime",e.time),c.worstTime=e.time),e.score>o&&(t.save("bestScore",e.score),c.bestScore=e.score),e.score<s&&(t.save("worstScore",e.score),c.worstScore=e.score)}),n.on("game.first.move",l),n.on("reset-stats",function n(){o.each(u,function(n,e){t.save(e,null),c[e]=u[e]}),s()}),n.on("show-stats",s)}),define("stats",["stats/main"],function(t){return t}),requirejs.config({packages:["view","Solitaire","UI","stats"],urlArgs:"bust="+(new Date).getTime(),waitSeconds:0,map:{"*":{Q:"vendor/q",EventEmitter:"vendor/EventEmitter.min",postal:"vendor/postal.min",underscore:"vendor/lodash.underscore",i18n:"vendor/require-plugins/i18n",image:"vendor/require-plugins/image",text:"vendor/require-plugins/text",images:"images"}},skipDirOptimize:!0,dir:"../build",name:"main",exclude:["nls/solitaire.js","nls/es/solitaire.js","nls/template/solitaire.js"]}),define("main",["UI","view","stats"],function(t,n){return function(n){t.initialize(n)}});